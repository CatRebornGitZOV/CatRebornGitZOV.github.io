<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FUMO — музыка 100% работает</title>
    <style>
        body{margin:0;height:100vh;overflow:hidden;background:linear-gradient(135deg,#ff9a9e,#fad0c4);cursor:crosshair;user-select:none}
        .fumo{position:fixed;pointer-events:none;object-fit:contain;filter:drop-shadow(0 8px 16px rgba(0,0,0,0.3))}
        #panel{position:fixed;top:15px;left:15px;background:rgba(0,0,0,0.7);color:white;padding:15px;border-radius:15px;font-family:Arial,sans-serif;z-index:9999;backdrop-filter:blur(10px)}
        #counter{font-size:24px;margin-bottom:10px}
        #add100{position:fixed;bottom:20px;left:20px;width:60px;height:60px;background:hotpink;color:white;font-size:18px;font-weight:bold;border:none;border-radius:50%;cursor:pointer;z-index:9999;box-shadow:0 4px 15px rgba(0,0,0,0.4)}
        #add100:hover{transform:scale(1.2)}
        #settingsBtn{position:fixed;top:20px;right:20px;background:rgba(0,0,0,0.6);color:white;border:none;padding:12px;border-radius:50%;font-size:24px;cursor:pointer;z-index:9999}
        #settingsMenu{position:fixed;top:70px;right:20px;background:rgba(0,0,0,0.85);color:white;padding:15px;border-radius:15px;font-family:Arial,sans-serif;z-index:9999;display:none;backdrop-filter:blur(10px)}
        #settingsMenu.show{display:block}
        .switch{position:relative;display:inline-block;width:50px;height:26px}
        .switch input{opacity:0;width:0;height:0}
        .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#444;transition:.4s;border-radius:34px}
        .slider:before{position:absolute;content:"";height:18px;width:18px;left:4px;bottom:4px;background:white;transition:.4s;border-radius:50%}
        input:checked+.slider{background:#ff69b4}
        input:checked+.slider:before{transform:translateX(24px)}
    </style>
</head>
<body>

<div id="panel">
    <div id="counter">FUMO: 3</div>
    <label>Скорость: <span id="speedVal">5.0</span></label>
    <input type="range" id="speedSlider" min="0.5" max="20" step="0.5" value="5">
</div>

<button id="add100">+100</button>
<button id="settingsBtn">⚙️</button>

<div id="settingsMenu">
    <div style="margin-bottom:10px;font-weight:bold;">Настройки</div>
    <label>Музыка
        <label class="switch">
            <input type="checkbox" id="musicToggle" checked>
            <span class="slider"></span>
        </label>
    </label>
</div>

<audio id="bgMusic" loop preload="auto">
    <source src="music.mp3" type="audio/mp3">
    Ваш браузер не поддерживает аудио
</audio>

<script>
    const counter = document.getElementById('counter');
    const speedSlider = document.getElementById('speedSlider');
    const speedVal = document.getElementById('speedVal');
    const add100Btn = document.getElementById('add100');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsMenu = document.getElementById('settingsMenu');
    const musicToggle = document.getElementById('musicToggle');
    const bgMusic = document.getElementById('bgMusic');
    const fumos = [];

    let globalSpeed = 5;
    let audioUnlocked = false;

    // ==== РАЗБЛОКИРОВКА МУЗЫКИ (главное исправление!) ====
    function unlockAudio() {
        if (audioUnlocked) return;
        bgMusic.volume = 0.4;
        bgMusic.play().then(() => {
            audioUnlocked = true;
        }).catch(() => {});
    }

    // Любой клик/тап разблокирует музыку
    document.body.addEventListener('click', unlockAudio, {once: true});
    document.body.addEventListener('touchstart', unlockAudio, {once: true});

    // Переключатель музыки
    musicToggle.addEventListener('change', () => {
        if (!audioUnlocked) unlockAudio();
        if (musicToggle.checked) {
            bgMusic.play();
        } else {
            bgMusic.pause();
        }
    });

    settingsBtn.addEventListener('click', () => settingsMenu.classList.toggle('show'));

    // Скорость (теперь работает на всех fumo)
    speedSlider.addEventListener('input', (e) => {
        globalSpeed = parseFloat(e.target.value);
        speedVal.textContent = globalSpeed.toFixed(1);
        fumos.forEach(f => {
            const len = Math.hypot(f.vx, f.vy);
            if (len > 0) {
                f.vx = f.vx / len * f.baseSpeed * (globalSpeed / 5);
                f.vy = f.vy / len * f.baseSpeed * (globalSpeed / 5);
            }
        });
    });

    class BouncingFumo {
        constructor(x = null, y = null) {
            this.img = document.createElement('img');
            this.img.src = "fumo.jpg";
            this.img.classList.add('fumo');
            document.body.appendChild(this.img);

            this.size = 70 + Math.random() * 110;
            this.img.style.width = this.size + 'px';
            this.img.style.height = this.size + 'px';

            this.x = x !== null ? x - this.size/2 : Math.random() * (window.innerWidth - this.size);
            this.y = y !== null ? y - this.size/2 : Math.random() * (window.innerHeight - this.size);

            this.baseSpeed = 1 + Math.random() * 4;
            const speed = this.baseSpeed * (globalSpeed / 5);
            this.angle = Math.random() * Math.PI * 2;
            this.vx = Math.cos(this.angle) * speed;
            this.vy = Math.sin(this.angle) * speed;

            fumos.push(this);
            counter.textContent = `FUMO: ${fumos.length}`;
        }

        animate() {
            this.x += this.vx; this.y += this.vy;
            if (this.x <= 0 || this.x + this.size >= window.innerWidth) { this.vx = -this.vx; this.x = Math.max(0, Math.min(window.innerWidth - this.size, this.x)); }
            if (this.y <= 0 || this.y + this.size >= window.innerHeight) { this.vy = -this.vy; this.y = Math.max(0, Math.min(window.innerHeight - this.size, this.y)); }
            this.img.style.left = this.x + 'px';
            this.img.style.top = this.y + 'px';
        }
    }

    for (let i = 0; i < 3; i++) new BouncingFumo();

    document.addEventListener('click', (e) => {
        if (e.target !== add100Btn && e.target !== settingsBtn && !settingsMenu.contains(e.target)) {
            new BouncingFumo(e.clientX, e.clientY);
        }
    });

    add100Btn.addEventListener('click', (e) => {
        e.stopPropagation();
        for (let i = 0; i < 100; i++) {
            new BouncingFumo(Math.random() * window.innerWidth, Math.random() * window.innerHeight);
        }
    });

    function animate() {
        fumos.forEach(f => f.animate());
        requestAnimationFrame(animate);
    }
    animate();

    window.addEventListener('resize', () => {
        fumos.forEach(f => {
            if (f.x + f.size > window.innerWidth) f.x = window.innerWidth - f.size;
            if (f.y + f.size > window.innerHeight) f.y = window.innerHeight - f.size;
        });
    });
</script>
</body>
</html>